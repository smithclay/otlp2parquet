# Cloudflare Workers configuration for otlp2parquet
# Deploy with: wrangler deploy

name = "otlp2parquet"
main = "crates/otlp2parquet-cloudflare/build/index.js"
compatibility_date = "2025-01-15"

# Worker compute settings
workers_dev = true

# Account information (set via wrangler login or environment)
# account_id = ""  # Optional: set via CLOUDFLARE_ACCOUNT_ID env var

# R2 bucket binding for log storage
[[r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs"  # Change this to your bucket name
preview_bucket_name = "otlp-logs-preview"  # Optional: separate bucket for dev

# Build configuration
[build]
command = "cd crates/otlp2parquet-cloudflare && cargo install -q worker-build && worker-build --release"

# Limits (Cloudflare Workers Free tier)
# - 100,000 requests/day
# - 10ms CPU time per request
# - 1MB WASM after compression (we're at ~1MB compressed)

# Environment variables (optional - for advanced config)
[vars]
OTLP2PARQUET_R2_BUCKET = "otlp-logs-preview"
OTLP2PARQUET_R2_ACCOUNT_ID = "test"
OTLP2PARQUET_R2_ACCESS_KEY_ID = "test"
OTLP2PARQUET_R2_SECRET_ACCESS_KEY = "test"  # For local testing only
# LOG_LEVEL = "info"
# MAX_BATCH_SIZE = "1000"

# Secrets (set with: wrangler secret put SECRET_NAME)
# These should NOT be in this file, use wrangler CLI:
# wrangler secret put R2_ACCESS_KEY_ID
# wrangler secret put R2_SECRET_ACCESS_KEY

# Development settings
[env.dev]
name = "otlp2parquet-dev"
workers_dev = true

[[env.dev.r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs-dev"

# Production settings
[env.production]
name = "otlp2parquet"
workers_dev = false
# route = "logs.example.com/*"  # Set your custom domain

[[env.production.r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs-production"

# Staging settings
[env.staging]
name = "otlp2parquet-staging"
workers_dev = false

[[env.staging.r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs-staging"
