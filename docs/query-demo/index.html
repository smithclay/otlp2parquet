<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Browser Observability Demo</title>
    <link rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer@3.1.0/dist/css/themes.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="header">
      <div class="header-top">
        <h1>Live Browser Observability</h1>
        <div class="status" id="status">
          <span id="status-text">Initializing...</span>
        </div>
      </div>
      <p class="header-subtitle">OTel JS SDK &rarr; otlp2parquet WASM &rarr; DuckDB &rarr; Perspective</p>

      <!-- Web Vitals Summary -->
      <div class="vitals-bar">
        <div class="vital" id="vital-lcp">
          <span class="vital-label">LCP</span>
          <span class="vital-value" id="lcp-value">--</span>
          <span class="vital-unit">ms</span>
        </div>
        <div class="vital" id="vital-fid">
          <span class="vital-label">FID</span>
          <span class="vital-value" id="fid-value">--</span>
          <span class="vital-unit">ms</span>
        </div>
        <div class="vital" id="vital-cls">
          <span class="vital-label">CLS</span>
          <span class="vital-value" id="cls-value">0.00</span>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- Left Panel: SQL Query (collapsible) -->
      <aside class="sidebar" id="sidebar">
        <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle SQL Panel">
          <span class="toggle-icon">&#9664;</span>
        </button>
        <div class="sidebar-content">
          <h2>SQL Query</h2>
          <div class="sql-examples">
            <button class="example" data-query="SELECT Timestamp, SeverityText, Body FROM logs ORDER BY Timestamp DESC LIMIT 20">Recent Logs</button>
            <button class="example" data-query="SELECT Timestamp, MetricName, Value FROM metrics_gauge ORDER BY Timestamp DESC LIMIT 50">Recent Metrics</button>
            <button class="example" data-query="SELECT Timestamp, SpanName, Duration/1000000.0 as duration_ms FROM traces ORDER BY Timestamp DESC LIMIT 20">Recent Traces</button>
            <button class="example" data-query="SELECT MetricName, AVG(Value) as avg_value, COUNT(*) as samples FROM metrics_gauge GROUP BY MetricName ORDER BY samples DESC">Metrics Summary</button>
          </div>
          <textarea id="sql" spellcheck="false">SELECT Timestamp, SeverityText, Body
FROM logs
ORDER BY Timestamp DESC
LIMIT 20</textarea>
          <div class="actions">
            <button id="run-query" disabled>Run Query (Ctrl+Enter)</button>
          </div>
          <div class="query-results">
            <h3>Query Results</h3>
            <perspective-viewer id="query-viewer"></perspective-viewer>
          </div>
        </div>
      </aside>

      <!-- Main Dashboard -->
      <section class="dashboard">
        <!-- Real-time Gauges Row -->
        <div class="gauges-row">
          <div class="gauge-card">
            <div class="gauge-ring" id="gauge-fps">
              <svg viewBox="0 0 100 100">
                <circle class="gauge-bg" cx="50" cy="50" r="45"/>
                <circle class="gauge-fill" cx="50" cy="50" r="45" id="fps-ring"/>
              </svg>
              <div class="gauge-center">
                <span class="gauge-value" id="fps-value">0</span>
                <span class="gauge-label">FPS</span>
              </div>
            </div>
          </div>

          <div class="gauge-card">
            <div class="gauge-ring" id="gauge-scroll">
              <svg viewBox="0 0 100 100">
                <circle class="gauge-bg" cx="50" cy="50" r="45"/>
                <circle class="gauge-fill" cx="50" cy="50" r="45" id="scroll-ring"/>
              </svg>
              <div class="gauge-center">
                <span class="gauge-value" id="scroll-value">0</span>
                <span class="gauge-label">Scroll %</span>
              </div>
            </div>
          </div>

          <div class="gauge-card">
            <div class="gauge-ring" id="gauge-interactions">
              <svg viewBox="0 0 100 100">
                <circle class="gauge-bg" cx="50" cy="50" r="45"/>
                <circle class="gauge-fill gauge-fill--accent" cx="50" cy="50" r="45" id="interactions-ring"/>
              </svg>
              <div class="gauge-center">
                <span class="gauge-value" id="interactions-value">0</span>
                <span class="gauge-label">Actions</span>
              </div>
            </div>
          </div>

          <div class="gauge-card gauge-card--stats">
            <div class="stat-row">
              <span class="stat-label">Time on Page</span>
              <span class="stat-value" id="time-value">0s</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Active Time</span>
              <span class="stat-value" id="active-value">0s</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Long Tasks</span>
              <span class="stat-value" id="longtasks-value">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">DOM Nodes</span>
              <span class="stat-value" id="dom-value">0</span>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row">
          <div class="chart-card chart-card--metrics">
            <h3>Metrics Over Time <span class="widget-count" id="metrics-count">0</span></h3>
            <perspective-viewer id="metrics-viewer"></perspective-viewer>
          </div>
        </div>

        <!-- Data Tables Row -->
        <div class="tables-row">
          <div class="table-card">
            <h3>Logs <span class="widget-count" id="logs-count">0</span></h3>
            <perspective-viewer id="logs-viewer"></perspective-viewer>
          </div>
          <div class="table-card">
            <h3>Traces <span class="widget-count" id="traces-count">0</span></h3>
            <perspective-viewer id="traces-viewer"></perspective-viewer>
          </div>
        </div>

        <!-- Interactive Playground -->
        <div class="playground-row">
          <div class="playground-card">
            <h3>Interactive Playground</h3>
            <p>Interact with these elements to generate real telemetry:</p>
            <div class="playground-grid">
              <div class="playground-section">
                <h4>Generate Activity</h4>
                <div class="playground-buttons">
                  <button id="btn-log">Log Message</button>
                  <button id="btn-error">Throw Error</button>
                  <button id="btn-slow">Slow Operation</button>
                  <button id="btn-nested">Nested Spans</button>
                </div>
              </div>
              <div class="playground-section">
                <h4>Stress Test</h4>
                <div class="playground-buttons">
                  <button id="btn-dom-stress">Add 100 DOM Nodes</button>
                  <button id="btn-layout-shift">Trigger Layout Shift</button>
                  <button id="btn-long-task">Block Main Thread (100ms)</button>
                </div>
              </div>
              <div class="playground-section">
                <h4>Scroll Target</h4>
                <div class="scroll-content" id="scroll-content">
                  <p>Scroll down to increase scroll depth metric...</p>
                  <div class="scroll-spacer"></div>
                  <p>You've reached the bottom!</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>
        Powered by <a href="https://github.com/smithclay/otlp2parquet">otlp2parquet</a> |
        <a href="https://perspective.finos.org/">Perspective</a> |
        <a href="https://duckdb.org/docs/api/wasm/overview">DuckDB-WASM</a>
      </p>
    </footer>

    <script type="module" src="app.js"></script>
  </body>
</html>
