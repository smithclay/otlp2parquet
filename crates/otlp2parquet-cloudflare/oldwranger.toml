# Cloudflare Workers configuration for otlp2parquet
# Deploy with: wrangler deploy

name = "otlp2parquet"
main = "build/index.js"
compatibility_date = "2025-01-15"

# Worker compute settings
workers_dev = true

# Account information (set via wrangler login or environment)
# account_id = ""  # Optional: set via CLOUDFLARE_ACCOUNT_ID env var

# R2 bucket binding for log storage
[[r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs"  # Change this to your bucket name
preview_bucket_name = "otlp-logs-preview"  # Optional: separate bucket for dev

# Build configuration
[build]
command = "cargo install -q worker-build && worker-build --release"

[limits]
cpu_ms = 2000  # 2 seconds for local testing

# Environment variables
[env]
# Max payload size (depends on your Cloudflare worker plan what the limit should be)
# OTLP2PARQUET_MAX_PAYLOAD_BYTES = "10485760"  # 10 MB, reasonable for free-tier

# Values for local minio started via `ocker-compose up minio minio-init`
[env.dev.vars]
OTLP2PARQUET_S3_BUCKET = "otlp-logs"
OTLP2PARQUET_S3_REGION = "us-east-1"
OTLP2PARQUET_S3_ENDPOINT = "http://localhost:9000"
OTLP2PARQUET_S3_ACCESS_KEY_ID = "minioadmin"
OTLP2PARQUET_S3_SECRET_ACCESS_KEY = "minioadmin"

# Values R2 bucket with S3-compatible API
[env.production.vars]
OTLP2PARQUET_S3_BUCKET = "otlp-logs"
OTLP2PARQUET_S3_REGION = "auto"

# S3-compatible endpoint (including R2)
# For Cloudflare R2: https://[account_id].r2.cloudflarestorage.com
OTLP2PARQUET_S3_ENDPOINT = "https://YOUR_ACCOUNT_HERE.r2.cloudflarestorage.com"

# Basic Authentication (optional)
# Set to "true" to enable HTTP Basic Authentication for all OTLP endpoints
# OTLP2PARQUET_BASIC_AUTH_ENABLED = "false"
# OTLP2PARQUET_BASIC_AUTH_USERNAME = "otlp-user"
# OTLP2PARQUET_BASIC_AUTH_PASSWORD = "your-password-here"

# Secrets (set with: wrangler secret put SECRET_NAME)
# For production, use secrets instead of vars for credentials:
# wrangler secret put OTLP2PARQUET_S3_ACCESS_KEY_ID
# wrangler secret put OTLP2PARQUET_S3_SECRET_ACCESS_KEY
# wrangler secret put OTLP2PARQUET_BASIC_AUTH_PASSWORD

# Development settings
[env.dev]
name = "otlp2parquet-dev"
workers_dev = true

[[env.dev.r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs-dev"

# Production settings
[env.production]
name = "otlp2parquet"
workers_dev = false
# route = "logs.example.com/*"  # Set your custom domain

[[env.production.r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs-production"

# Staging settings
[env.staging]
name = "otlp2parquet-staging"
workers_dev = false

[[env.staging.r2_buckets]]
binding = "LOGS_BUCKET"
bucket_name = "otlp-logs-staging"
