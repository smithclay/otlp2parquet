name: Smoke Tests

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:

jobs:
  # Lambda + S3 Tables smoke tests (conditional on AWS credentials)
  lambda-smoke:
    name: Lambda + S3 Tables
    runs-on: ubuntu-latest
    # Only run on main branch OR if PR has 'test-lambda' label
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test-lambda'))

    permissions:
      id-token: write  # For AWS OIDC
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_SMOKE_TEST_ROLE_ARN }}
          aws-region: us-west-2

      - name: Build Lambda binary
        run: make build-lambda

      - name: Run Lambda smoke tests
        run: cargo test --test smoke --features smoke-lambda -- --test-threads=1
        env:
          SMOKE_TEST_STACK_PREFIX: gh-${{ github.run_id }}
          SMOKE_TEST_AWS_REGION: us-west-2
          SMOKE_TEST_DEPLOYMENT_BUCKET: ${{ secrets.AWS_SMOKE_TEST_DEPLOYMENT_BUCKET }}
          SMOKE_TEST_S3_TABLES_NAMESPACE: otel_smoke
          RUST_LOG: info

      - name: Cleanup on failure
        if: failure()
        run: |
          aws cloudformation delete-stack \
            --stack-name smoke-lambda-gh-${{ github.run_id }} \
            --region us-west-2 || true

  # Cloudflare Workers + R2 smoke tests (conditional on Cloudflare credentials)
  workers-smoke:
    name: Cloudflare Workers + R2
    runs-on: ubuntu-latest
    # Only run on main branch OR if PR has 'test-workers' label
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test-workers'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Build WASM
        run: make wasm-compress

      - name: Run Workers smoke tests
        run: cargo test --test smoke --features smoke-workers -- --test-threads=1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          SMOKE_TEST_WORKER_PREFIX: gh-${{ github.run_id }}
          CLOUDFLARE_BUCKET_NAME: ${{ secrets.CLOUDFLARE_R2_BUCKET }}
          SMOKE_TEST_R2_CATALOG_ENDPOINT: ${{ secrets.CLOUDFLARE_R2_CATALOG_ENDPOINT }}
          CF_R2_ACCESS_KEY_ID: ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          CF_R2_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
          RUST_LOG: info

      - name: Cleanup on failure
        if: failure()
        run: |
          wrangler delete gh-${{ github.run_id }} --force || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
