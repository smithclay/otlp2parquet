name: CI

# Validates the server target (default mode - native binary with OpenDAL multi-backend)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
    paths:
      - "**/*.rs"
      - "**/Cargo.toml"
      - "Cargo.lock"
      - "**/build.rs"
      - "rust-toolchain.toml"
      - ".cargo/**"
      - ".github/workflows/ci.yml"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0  # Disable incremental compilation for CI (faster clean builds)
  CARGO_PROFILE_DEV_DEBUG: 0  # Reduce debug info to save cache space
  CARGO_NET_GIT_FETCH_WITH_CLI: true  # More reliable git fetching
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Check code formatting
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure toolchain
        uses: ./.github/actions/setup-rust
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          components: rustfmt
          cache-prefix: fmt
          cache-key: fmt
      - name: Check formatting
        run: make fmt-check

  # Run clippy lints
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure toolchain
        uses: ./.github/actions/setup-rust
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          components: clippy
          cache-prefix: clippy
          cache-key: all-targets
      - name: Run clippy
        run: make clippy

  # Run tests
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure toolchain
        uses: ./.github/actions/setup-rust
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix: test
          cache-key: full-suite
      - name: Run tests
        run: make test

  # Build for different feature combinations
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure toolchain
        uses: ./.github/actions/setup-rust
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix: build
          cache-key: release
      - name: Build release binaries
        run: make build-release

  # Security audit
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # Check documentation builds
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure toolchain
        uses: ./.github/actions/setup-rust
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix: docs
          cache-key: all-features
      - name: Check documentation
        run: cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  # Server smoke tests with Docker (no cloud credentials required)
  smoke-server:
    name: Server Smoke Tests
    runs-on: ubuntu-latest
    # Skip on draft PRs to save CI resources
    if: github.event.pull_request.draft == false || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Configure toolchain
        uses: ./.github/actions/setup-rust
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix: smoke-server
          cache-key: docker-tests

      - name: Install DuckDB
        run: |
          wget https://github.com/duckdb/duckdb/releases/download/v1.4.2/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          sudo mv duckdb /usr/local/bin/
          duckdb --version

      - name: Run server smoke tests
        run: make smoke-server

      - name: Docker logs on failure
        if: failure()
        run: docker compose logs

  build-artifacts:
    name: Package Release Artifacts
    needs:
      - fmt
      - clippy
      - test
      - build
      - audit
      - docs
      - smoke-server
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/build-artifacts.yml
    secrets: inherit
