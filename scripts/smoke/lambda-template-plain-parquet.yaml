AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'otlp2parquet Lambda with plain Parquet to S3 (no catalog)'

Parameters:
  S3BucketName:
    Type: String
    Description: Name for the S3 bucket (must be globally unique, leave empty for auto-generated)
    Default: ''

  IcebergNamespace:
    Type: String
    Description: Namespace prefix for Parquet file paths (e.g., otel_smoke)
    Default: 'otel_smoke'

Resources:
  # Regular S3 bucket for plain Parquet files
  DataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If
        - HasCustomBucketName
        - !Ref S3BucketName
        - !Sub 'otlp2parquet-plain-${AWS::StackName}-${AWS::AccountId}'
      # Enable versioning for data protection
      VersioningConfiguration:
        Status: Enabled
      # Lifecycle rule to expire old versions after 7 days (smoke test cleanup)
      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 7
          - Id: ExpireCurrentVersions
            Status: Enabled
            ExpirationInDays: 7

  # Lambda execution role with S3 permissions only
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        # Basic execution role for CloudWatch Logs
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3DataAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 permissions for writing Parquet files
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt DataBucket.Arn
                  - !Sub '${DataBucket.Arn}/*'

  # CloudWatch log group with 7-day retention for cost optimization
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-ingest'
      RetentionInDays: 7

  # Lambda function running otlp2parquet Rust binary
  OtlpIngestFunction:
    Type: AWS::Serverless::Function
    DependsOn: LambdaLogGroup
    Properties:
      FunctionName: !Sub '${AWS::StackName}-ingest'
      Runtime: provided.al2023
      Handler: bootstrap
      CodeUri: ../../target/lambda/bootstrap-arm64.zip
      Role: !GetAtt LambdaExecutionRole.Arn
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          # Plain Parquet mode - no catalog
          OTLP2PARQUET_CATALOG_MODE: 'none'

          # S3 storage configuration
          OTLP2PARQUET_S3_BUCKET: !Ref DataBucket
          OTLP2PARQUET_S3_REGION: !Ref AWS::Region

          # Namespace for directory structure
          OTLP2PARQUET_ICEBERG_NAMESPACE: !Ref IcebergNamespace

          # Logging
          RUST_LOG: 'info'

  # Lambda Function URL for HTTP ingestion
  OtlpFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE  # Public endpoint for smoke tests (not for production!)
      TargetFunctionArn: !GetAtt OtlpIngestFunction.Arn

  # Lambda permission for Function URL invocations
  OtlpFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref OtlpIngestFunction
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
      FunctionUrlAuthType: NONE

Conditions:
  HasCustomBucketName:
    Fn::Not:
      - Fn::Equals:
          - Ref: S3BucketName
          - ''

Outputs:
  LambdaFunctionArn:
    Description: Lambda function ARN (use for testing with aws lambda invoke)
    Value: !GetAtt OtlpIngestFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaArn'

  LambdaFunctionName:
    Description: Lambda function name
    Value: !Ref OtlpIngestFunction
    Export:
      Name: !Sub '${AWS::StackName}-LambdaName'

  FunctionUrl:
    Description: Lambda Function URL for OTLP ingestion
    Value: !GetAtt OtlpFunctionUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-FunctionUrl'

  LambdaRoleArn:
    Description: Lambda execution role ARN
    Value: !GetAtt LambdaExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaRoleArn'

  DataBucketName:
    Description: S3 bucket name for plain Parquet files
    Value: !Ref DataBucket
    Export:
      Name: !Sub '${AWS::StackName}-DataBucket'

  DataBucketArn:
    Description: S3 bucket ARN for plain Parquet files
    Value: !GetAtt DataBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-DataBucketArn'

  Namespace:
    Description: Namespace prefix for Parquet file paths
    Value: !Ref IcebergNamespace
    Export:
      Name: !Sub '${AWS::StackName}-Namespace'

  Region:
    Description: AWS Region where resources are deployed
    Value: !Ref AWS::Region
    Export:
      Name: !Sub '${AWS::StackName}-Region'

  # Query Example
  DuckDBQueryExample:
    Description: Example DuckDB query to read Parquet files
    Value: !Sub |
      -- Install and load AWS extension
      INSTALL aws;
      LOAD aws;

      -- Query logs
      SELECT * FROM read_parquet('s3://${DataBucket}/logs/**/year=*/month=*/day=*/hour=*/*.parquet');

      -- Query metrics (gauge)
      SELECT * FROM read_parquet('s3://${DataBucket}/metrics/gauge/**/year=*/month=*/day=*/hour=*/*.parquet');

      -- Query traces
      SELECT * FROM read_parquet('s3://${DataBucket}/traces/**/year=*/month=*/day=*/hour=*/*.parquet');
